---
title: 'ğŸ½ Jenkins Pipeline & ä»£ç ç®¡ç†'
---

# Jenkins PipelineåŸºç¡€è¯­æ³•

## ä»€ä¹ˆæ˜¯Pipeline

Pipelineæ˜¯Jenkinsçš„ä¸€ä¸ªæ ¸å¿ƒç‰¹æ€§ï¼ŒPipelineæä¾›äº†ä¸€ç»„å¯æ‰©å±•çš„å·¥å…·ï¼Œ
ç”¨äºå°†"ç®€å•åˆ°å¤æ‚"çš„äº¤ä»˜æµç¨‹ä»¥ä»£ç çš„å½¢å¼å®ç°å’Œé›†æˆåˆ°Jenkinsä¸­ã€‚
Jenkinsåœ¨è¿è¡ŒPipelineä»»åŠ¡çš„æ—¶å€™ä¼šæŒ‰ç…§Jenkinsfileä¸­å®šä¹‰çš„ä»£ç é¡ºåºæ‰§è¡Œã€‚
Jenkinsfileç±»ä¼¼äºDockerfileï¼Œå…·æœ‰ä¸€å¥—ç‰¹å®šçš„è¯­æ³•ã€‚

## å¦‚ä½•ä½¿ç”¨Pipeline

## å®‰è£…Pipelineæ’ä»¶
<Info>åœ¨åˆå§‹åŒ–Jenkins çš„æ—¶å€™ä¼šé»˜è®¤å®‰è£…å¥½pipelineæ’ä»¶</Info>
åœ¨åˆ›å»ºPipelineç±»å‹çš„ä½œä¸šçš„æ—¶å€™ï¼Œéœ€è¦æå‰å®‰è£…å¥½pipelineæ’ä»¶ï¼Œä¸ç„¶å¯èƒ½ä¼šå‡ºç°æ‰¾ä¸åˆ°pipelineç±»å‹çš„ä½œä¸šã€‚
è¿›å…¥æ’ä»¶ç®¡ç†ï¼Œ æœç´¢å…³é”®å­—"pipeline" ã€‚å®‰è£…åé‡å¯ä¸€ä¸‹ã€‚


![](https://s3api.srebro.cn:443/picgo/202506061747747.png)
å½“Jenkinsé‡å¯æˆåŠŸåï¼Œæˆ‘ä»¬åˆ›å»ºä¸€ä¸ªæµæ°´çº¿ç±»å‹çš„ä½œä¸šã€‚
![](https://s3api.srebro.cn:443/picgo/202506061749462.png)
ç¼–å†™æµæ°´çº¿ä»£ç 
![](https://s3api.srebro.cn:443/picgo/202506061750957.png)


## å¦‚ä½•ç¼–å†™Pipelineï¼Ÿ

Jenkinsfileæ˜¯ä¸€ä¸ªæ–‡æœ¬æ–‡ä»¶ï¼ŒåŒ…å«äº†Jenkins Pipelineçš„å®šä¹‰ã€‚å®ƒå¯ä»¥è¢«æäº¤åˆ°é¡¹ç›®çš„æºä»£ç æ§åˆ¶ä»“åº“ä¸­ï¼ˆ`Jenkinsfile`ï¼Œæ¯”å¦‚æˆ‘ä»¬åé¢è¦è¯´åˆ°çš„å…±äº«åº“ï¼‰ï¼Œä¹Ÿå¯ä»¥ç›´æ¥å†™åœ¨Jenkinsçš„é…ç½®é¡µé¢ä¸­ã€‚
åŸºæœ¬ç¤ºä¾‹ï¼š
```groovy
pipeline {
    agent any
    
    stages {
        stage('Build') {
            steps {
                echo 'Building..'
            }
        }
        stage('Test') {
            steps {
                echo 'Testing..'
            }
        }
        stage('Deploy') {
            steps {
                echo 'Deploying....'
            }
        }
    }
}
```

## å£°æ˜å¼ç®¡é“ä¸è„šæœ¬å¼ç®¡é“

Jenkins Pipelineæ”¯æŒä¸¤ç§è¯­æ³•ï¼šå£°æ˜å¼ï¼ˆDeclarativeï¼‰å’Œè„šæœ¬å¼ï¼ˆScriptedï¼‰ï¼Œæ˜¯ä¸¤ç§ä¸åŒçš„è¯­æ³•é£æ ¼ï¼Œä¸»è¦åŒºåˆ«ä½“ç°åœ¨â€‹â€‹ç»“æ„åŒ–ç¨‹åº¦â€‹â€‹ã€â€‹â€‹è¯­æ³•çº¦æŸâ€‹â€‹å’Œâ€‹â€‹é€‚ç”¨åœºæ™¯â€‹â€‹ä¸Šã€‚
ä»¥ä¸‹é€šè¿‡å…·ä½“ä»£ç ç¤ºä¾‹å’Œå¯¹æ¯”è¯´æ˜ä¸¤è€…çš„å·®å¼‚ã€‚

<Info>ä»¥ä¸‹é€šè¿‡ä¸€ä¸ªã€Œæ„å»ºå¹¶éƒ¨ç½² Java åº”ç”¨ã€çš„ Pipeline åœºæ™¯ï¼Œåˆ†åˆ«ç”¨å£°æ˜å¼å’Œè„šæœ¬å¼å®ç°</Info>

### å£°æ˜å¼Pipeline
- å¼ºåˆ¶ä½¿ç”¨ stages åˆ’åˆ†é˜¶æ®µï¼Œæ¯ä¸ªé˜¶æ®µçš„ steps å¿…é¡»æ˜ç¡®
- æ›´ä¸¥æ ¼çš„è¯­æ³•ç»“æ„
- æ›´å®¹æ˜“è¯»å†™
- ä»Jenkins 2.5å¼€å§‹å¼•å…¥
```groovy
pipeline {
  agent any  // å¿…é¡»æŒ‡å®šæ‰§è¡ŒèŠ‚ç‚¹
  stages {
    stage('Hello') {  // å¿…é¡»ç”¨ stage åˆ’åˆ†é˜¶æ®µ
      steps {
        sh 'echo "å£°æ˜å¼ï¼šHello World"'  // æ­¥éª¤å¿…é¡»åœ¨ steps å—å†…
      }
    }
  }
}
```

### è„šæœ¬å¼Pipeline
- åŸºäºGroovyè¯­è¨€
- æä¾›æ›´å¤§çš„çµæ´»æ€§
- æ— å¼ºåˆ¶ç»“æ„ï¼Œç”¨ node æ›¿ä»£ agentï¼Œæ­¥éª¤æ›´è‡ªç”±
```groovy
node {  // ç”¨ node æ›¿ä»£ agentï¼ˆå¯é€‰ï¼Œä½†é€šå¸¸ä¿ç•™ï¼‰
  stage('Hi') {  // stage å¯é€‰ï¼ˆä½†ä¹ æƒ¯ä¿ç•™ï¼‰
    sh 'echo "è„šæœ¬å¼ï¼šHi Jenkins"'  // æ­¥éª¤ç›´æ¥å†™ï¼Œæ— éœ€ steps å—
  }
  // ç›´æ¥åµŒå…¥ Groovy é€»è¾‘ï¼ˆå£°æ˜å¼åšä¸åˆ°ï¼‰
  def msg = 'åŠ¨æ€æ¶ˆæ¯'
  sh "echo ${msg}"  // ç›´æ¥æ‹¼æ¥å˜é‡ï¼ˆå£°æ˜å¼éœ€ç”¨ env æˆ–ç‰¹å®šå—ï¼‰
}
```

### å£°æ˜å¼ä¸è„šæœ¬å¼æ ¸å¿ƒå·®å¼‚
- å£°æ˜å¼åƒã€Œå¡«è¡¨æ ¼ã€ï¼ˆå¿…é¡»æŒ‰ pipeline > agent > stages > steps ç»“æ„å¡«å†™ï¼‰ï¼›
- è„šæœ¬å¼åƒã€Œå†™ä»£ç ã€ï¼ˆç”¨ Groovy è‡ªç”±ç»„åˆï¼Œnode/stage/sh éšæ„åµŒå¥—ï¼‰ã€‚



## Pipelineè¯­æ³•æ ¸å¿ƒç»„ä»¶

### 1. Pipeline
Pipelineæ˜¯å£°æ˜å¼Pipelineçš„é¡¶å±‚ç»„ä»¶ï¼š
```groovy
pipeline {
    // æ‰€æœ‰çš„å£°æ˜å¼Pipelineå†…å®¹
}
```

### 2. Agent
Jenkinsé‡‡ç”¨åˆ†å¸ƒå¼æ¶æ„ï¼Œåˆ†ä¸ºserverèŠ‚ç‚¹å’ŒagentèŠ‚ç‚¹ã€‚serverèŠ‚ç‚¹ä¹Ÿæ˜¯å¯ä»¥è¿è¡Œæ„å»ºä»»åŠ¡çš„ï¼Œä¸€èˆ¬ä½¿å…¶ä¸»è¦æ¥åšä»»åŠ¡çš„è°ƒåº¦ã€‚agentèŠ‚ç‚¹ä¸“é—¨ç”¨äºä»»åŠ¡çš„æ‰§è¡Œã€‚
éšç€ç°åœ¨å®¹å™¨çš„ç››è¡Œï¼ŒagentèŠ‚ç‚¹å¯ä»¥åˆ†ä¸ºé™æ€èŠ‚ç‚¹å’ŒåŠ¨æ€èŠ‚ç‚¹ã€‚ é™æ€èŠ‚ç‚¹æ˜¯å›ºå®šçš„ä¸€å°vmè™šæœºæˆ–è€…å®¹å™¨ã€‚åŠ¨æ€èŠ‚ç‚¹æ˜¯éšç€ä»»åŠ¡çš„æ„å»ºæ¥è‡ªåŠ¨åˆ›å»ºagentèŠ‚ç‚¹ã€‚
```groovy
agent {
    label 'my-defined-label'
}

// æˆ–è€…ç®€å•å½¢å¼
agent any
```

### 3. Stages
åœ¨Jenkins pipelineä¸­ï¼Œä¸€æ¡æµæ°´çº¿æ˜¯ç”±å¤šä¸ªé˜¶æ®µç»„æˆçš„ï¼Œæ¯ä¸ªé˜¶æ®µä¸€ä¸ªstageã€‚ä¾‹å¦‚ï¼šæ„å»ºã€æµ‹è¯•ã€éƒ¨ç½²ç­‰ç­‰ã€‚
```groovy
stages {
    stage('Build') { ... }
    stage('Test') { ... }
    stage('Deploy') { ... }
}
```

### 4. Stage
å®šä¹‰æ¦‚å¿µæ€§çš„ä¸åŒçš„æ„å»ºé˜¶æ®µï¼š
```groovy
stage('Build') {
    steps {
        sh 'make'
    }
}
```

### 5. Post
å®šä¹‰Pipelineæˆ–stageå®Œæˆåçš„æ“ä½œï¼š
```groovy
post {
    always {
        echo 'This will always run'
    }
    success {
        echo 'This will run only if successful'
    }
    failure {
        echo 'This will run only if failed'
    }
}
```

æˆ‘ä»¬å¯ä»¥æ ¹æ®åœ°é“çº¿è·¯å›¾æ¥ç†è§£pipeline ï¼š

- â€‹pipelineâ€‹â€‹ï¼šæ•´æ¡åœ°é“ 1 å·çº¿çš„ã€Œè¿è¥ä½“ç³»ã€ï¼ˆä»è§„åˆ’åˆ°è¿è¡Œçš„æ•´ä½“æ¡†æ¶ï¼‰ã€‚
- â€‹â€‹agentâ€‹â€‹ï¼šæ‰§è¡Œè¿è¾“çš„ã€Œåœ°é“åˆ—è½¦ã€ï¼ˆæ‰¿è½½ä»»åŠ¡è¿è¡Œçš„è½½ä½“ï¼‰ã€‚
- â€‹â€‹stagesâ€‹â€‹ï¼šåœ°é“ 1 å·çº¿çš„ã€Œå®Œæ•´ç«™ç‚¹è·¯çº¿ã€ï¼ˆä»èµ·ç‚¹åˆ°ç»ˆç‚¹çš„æ‰€æœ‰ç«™ç‚¹é¡ºåºè§„åˆ’ï¼‰ã€‚
- â€‹â€‹stageâ€‹â€‹ï¼šè·¯çº¿ä¸­çš„ã€Œå•ä¸ªç«™ç‚¹ã€å¯¹åº” Pipeline ä¸­ä¸€ä¸ªå…·ä½“çš„ä»»åŠ¡æ­¥éª¤ï¼‰ã€‚
- â€‹â€‹postâ€‹â€‹ï¼šåˆ—è½¦å®Œæˆã€Œå…¨ç¨‹è¿è¡Œï¼ˆæ‰€æœ‰ç«™ç‚¹ï¼‰ã€åçš„ã€Œæ”¶å°¾æ“ä½œã€ï¼ˆä¾‹å¦‚ï¼šåˆ°è¾¾ç»ˆç‚¹ç«™åæ¸…å®¢ã€æ£€æŸ¥è½¦è¾†çŠ¶æ€ã€ä¸ºä¸‹ä¸€ç­æ¬¡åšå‡†å¤‡ç­‰ï¼‰ã€‚

<Card title="å—äº¬åœ°é“ğŸš‡ä¸€å·çº¿" img="https://s3api.srebro.cn:443/picgo/202506061637422.jpg">
  è½¨é“äº¤é€šçº¿è·¯å›¾
</Card>


## é«˜çº§Pipelineç»„ä»¶

### 1. Environment
å®šä¹‰ç¯å¢ƒå˜é‡ï¼š
```groovy
environment {
    MAVEN_HOME = '/usr/local/maven'
}
```

### 2. Options
Pipelineç‰¹å®šé€‰é¡¹ï¼š
```groovy
options {
    timeout(time: 1, unit: 'HOURS')
    disableConcurrentBuilds()
}
```

### 3. Parameters
æ„å»ºå‚æ•°ï¼š
```groovy
parameters {
    string(name: 'DEPLOY_ENV', defaultValue: 'staging', description: '')
    booleanParam(name: 'DEBUG_BUILD', defaultValue: true, description: '')
}
```

### 4. Triggers
æ„å»ºè§¦å‘å™¨ï¼š
```groovy
triggers {
    cron('H */4 * * 1-5')
    pollSCM('H */4 * * 1-5')
}
```

### 5. Tools
è‡ªåŠ¨å®‰è£…å’Œæ”¾å…¥PATHçš„å·¥å…·ï¼š
```groovy
tools {
    maven 'apache-maven-3.8.1'
    jdk 'jdk11'
}
```

### 6. Input
äººå·¥è¾“å…¥ï¼š
```groovy
input {
    message "Should we continue?"
    ok "Yes, we should."
    parameters {
        string(name: 'PERSON', defaultValue: 'Mr Jenkins', description: 'Who should I say hello to?')
    }
}
```

### 7. When
æ¡ä»¶æ‰§è¡Œï¼š
```groovy
when {
    branch 'master'
    environment name: 'DEPLOY_TO', value: 'production'
}
```

### 8. Script
åœ¨å£°æ˜å¼Pipelineä¸­æ‰§è¡Œè„šæœ¬å¼Pipelineä»£ç ï¼š
```groovy
script {
    def browsers = ['chrome', 'firefox']
    for (int i = 0; i < browsers.size(); ++i) {
        echo "Testing the ${browsers[i]} browser"
    }
}
```

# Jenkins Pipelineå¼€å‘æŠ€å·§

## ç¼–å†™æµ‹è¯•Pipeline

1. **ä½¿ç”¨ReplayåŠŸèƒ½**
   - åœ¨Jenkins UIä¸­å¯ä»¥å¿«é€Ÿæµ‹è¯•Pipelineä¿®æ”¹
   - ä¸éœ€è¦æäº¤åˆ°SCMå°±èƒ½æµ‹è¯•æ”¹åŠ¨

2. **ä½¿ç”¨Pipeline Syntaxç”Ÿæˆå™¨**
   - Jenkinsæä¾›äº†è¯­æ³•ç”Ÿæˆå™¨
   - ä½äºPipeline jobçš„"Pipeline Syntax"é“¾æ¥

3. **åˆ†é˜¶æ®µéªŒè¯**
```groovy
pipeline {
    agent any
    stages {
        stage('Validate') {
            steps {
                sh 'echo "First, validate the app..."'
                sh 'make validate'
            }
        }
        stage('Test') {
            steps {
                sh 'echo "Next, test the app..."'
                sh 'make test'
            }
        }
    }
}
```

## Pipelineé—®é¢˜æ’é”™æ€è·¯

1. **æŸ¥çœ‹Pipeline Steps**
   - ä½¿ç”¨Blue Oceanæ’ä»¶å¯è§†åŒ–æŸ¥çœ‹æ­¥éª¤
   - æ£€æŸ¥æ¯ä¸ªæ­¥éª¤çš„æ—¥å¿—è¾“å‡º

2. **ä½¿ç”¨echoè°ƒè¯•**
```groovy
steps {
    script {
        echo "DEBUG: Current environment is ${env.ENVIRONMENT}"
        echo "DEBUG: Build number is ${env.BUILD_NUMBER}"
    }
}
```

3. **ä½¿ç”¨try-catchå¤„ç†é”™è¯¯**
```groovy
steps {
    script {
        try {
            sh 'some-command'
        } catch (exc) {
            echo 'Something failed, but I want to keep going'
        }
    }
}
```

## Jenkinsfileçš„å¸¸è§ç®¡ç†æ–¹å¼

1. **æºä»£ç æ§åˆ¶**
   - å°†Jenkinsfileæ”¾åœ¨ä»£ç ä»“åº“çš„æ ¹ç›®å½•
   - ä¸åº”ç”¨ä»£ç ä¸€èµ·ç‰ˆæœ¬æ§åˆ¶

2. **å…±äº«åº“**
```groovy
@Library('my-shared-library') _

pipeline {
    agent any
    stages {
        stage('Example') {
            steps {
                mySharedFunction()
            }
        }
    }
}
```

3. **æ¨¡æ¿åŒ–**
   - åˆ›å»ºæ ‡å‡†åŒ–çš„Pipelineæ¨¡æ¿
   - åœ¨ä¸åŒé¡¹ç›®ä¸­é‡ç”¨
```groovy
// Template Jenkinsfile
def call(Map config) {
    pipeline {
        agent any
        stages {
            stage('Build') {
                steps {
                    sh "${config.buildCommand}"
                }
            }
        }
    }
}
```

4. **é…ç½®å³ä»£ç **
   - ä½¿ç”¨YAMLæˆ–JSONé…ç½®æ–‡ä»¶
   - Pipelineè¯»å–é…ç½®æ–‡ä»¶åŠ¨æ€ç”Ÿæˆæ­¥éª¤
```groovy
def config = readYaml file: 'jenkins-config.yml'
pipeline {
    agent any
    stages {
        stage('Dynamic Stage') {
            steps {
                script {
                    config.steps.each { step ->
                        sh "${step}"
                    }
                }
            }
        }
    }
}
```

é€šè¿‡ä»¥ä¸Šå†…å®¹ï¼Œä½ åº”è¯¥èƒ½å¤Ÿå¼€å§‹ä½¿ç”¨Jenkins Pipelineï¼Œå¹¶ä¸”äº†è§£å¦‚ä½•ç¼–å†™ã€æµ‹è¯•å’Œç®¡ç†Pipelineä»£ç ã€‚è®°ä½ï¼Œå¥½çš„Pipelineåº”è¯¥æ˜¯å¯ç»´æŠ¤çš„ã€å¯é‡ç”¨çš„ï¼Œå¹¶ä¸”èƒ½å¤Ÿæ¸…æ™°åœ°è¡¨è¾¾ä½ çš„æŒç»­äº¤ä»˜æµç¨‹ã€‚