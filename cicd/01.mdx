---
title: '01 ğŸ™ƒ'
description: 'Ansible + jenkins + Library'
---

ä»¥ä¸‹æ˜¯é’ˆå¯¹ä¼ä¸šçº§è‡ªåŠ¨åŒ–éƒ¨ç½²å¹³å°æ­å»ºæ–¹æ¡ˆçš„å®Œå–„å†…å®¹ï¼Œç»“åˆæœ€ä½³å®è·µå’Œè¡Œä¸šè§£å†³æ–¹æ¡ˆï¼Œæ•´åˆäº†å¤šä¸ªæŠ€æœ¯æ ˆçš„ååŒè®¾è®¡ï¼š

------

### **ä¼ä¸šçº§è‡ªåŠ¨åŒ–éƒ¨ç½²å¹³å°æ­å»ºæ–¹æ¡ˆ**

------

#### **1. Jenkinséƒ¨ç½²æ–¹å¼å¯¹æ¯”ä¸é€‰å‹**

| **éƒ¨ç½²æ–¹å¼**       | **ç‰¹ç‚¹**                              | **é€‚ç”¨åœºæ™¯**                 | **ä¼˜ç¼ºç‚¹**                               |
| ------------------ | ------------------------------------- | ---------------------------- | ---------------------------------------- |
| **ç‹¬ç«‹æœåŠ¡å™¨éƒ¨ç½²** | ç›´æ¥å®‰è£…Jenkins WARåŒ…ï¼Œä¾èµ–Javaç¯å¢ƒ   | ä¸­å°å‹é¡¹ç›®ã€å¿«é€ŸéªŒè¯         | ç®€å•æ˜“ç”¨ï¼Œä½†æ‰©å±•æ€§å·®ï¼Œå•ç‚¹æ•…éšœé£é™©é«˜     |
| **Dockerå®¹å™¨éƒ¨ç½²** | é€šè¿‡Dockeré•œåƒå¿«é€Ÿå¯åŠ¨ï¼Œéš”ç¦»ç¯å¢ƒ      | å¼€å‘æµ‹è¯•ç¯å¢ƒã€CI/CDæµæ°´çº¿    | ç¯å¢ƒä¸€è‡´æ€§é«˜ï¼Œä½†é•œåƒä½“ç§¯å¤§ï¼Œç½‘ç»œé…ç½®å¤æ‚ |
| **Kubernetesé›†ç¾¤** | ä»¥Podå½¢å¼è¿è¡Œï¼Œæ”¯æŒåŠ¨æ€æ‰©ç¼©å®¹ã€é«˜å¯ç”¨ | å¤§è§„æ¨¡ç”Ÿäº§ç¯å¢ƒã€å¼¹æ€§è®¡ç®—åœºæ™¯ | é…ç½®å¤æ‚ï¼Œéœ€K8såŸºç¡€ï¼Œé€‚åˆäº‘åŸç”Ÿæ¶æ„      |
| **åˆ†å¸ƒå¼éƒ¨ç½²**     | MasterèŠ‚ç‚¹è°ƒåº¦ä»»åŠ¡ï¼ŒAgentèŠ‚ç‚¹æ‰§è¡Œæ„å»º | å¤šå›¢é˜Ÿåä½œã€èµ„æºéš”ç¦»         | æ‰©å±•æ€§å¼ºï¼Œä½†éœ€ç®¡ç†èŠ‚ç‚¹ç½‘ç»œå’Œæƒé™         |

**é€‰å‹å»ºè®®**ï¼š

- **ç”Ÿäº§ç¯å¢ƒ**ï¼šä¼˜å…ˆé€‰æ‹©Kubernetesé›†ç¾¤éƒ¨ç½²ï¼Œç»“åˆJenkins Operatorå®ç°è‡ªåŠ¨åŒ–æ‰©ç¼©å®¹ã€‚
- **æ··åˆç¯å¢ƒ**ï¼šé‡‡ç”¨Master+Agentåˆ†å¸ƒå¼æ¶æ„ï¼ŒAgentèŠ‚ç‚¹æŒ‰éœ€éƒ¨ç½²åœ¨ç‰©ç†æœº/è™šæ‹Ÿæœº/K8sé›†ç¾¤ä¸­ã€‚

------

#### **2. Jenkinsæ ¸å¿ƒéƒ¨ç½²æµç¨‹**

1. **ç¯å¢ƒå‡†å¤‡**

   - **æ“ä½œç³»ç»Ÿ**ï¼šæ¨èUbuntu/CentOSï¼ˆéœ€æå‰å®‰è£…Dockerã€Java 17+ï¼‰ã€‚
   - **ç½‘ç»œé…ç½®**ï¼šå¼€æ”¾8080ç«¯å£ï¼Œé…ç½®åå‘ä»£ç†ï¼ˆNginxï¼‰æå‡å®‰å…¨æ€§ã€‚
   - **å­˜å‚¨æŒ‚è½½**ï¼šä½¿ç”¨PVCæŒä¹…åŒ–Jenkinsä¸»ç›®å½•ï¼ˆ`/var/jenkins_home`ï¼‰ã€‚

2. **å®‰è£…ä¸é…ç½®**

   ```
   # Dockeréƒ¨ç½²ç¤ºä¾‹
   docker run -d -p 8080:8080 -p 50000:50000 -v jenkins_home:/var/jenkins_home jenkins/jenkins:lts
   ```

   - **æ’ä»¶å®‰è£…**ï¼šPipelineã€Ansibleã€Kubernetesã€ArgoCDã€SonarQubeç­‰ã€‚
   - **å‡­è¯ç®¡ç†**ï¼šé€šè¿‡Jenkinså‡­è¯æ’ä»¶å­˜å‚¨Gitå¯†é’¥ã€Ansible Vaultå¯†ç ç­‰æ•æ„Ÿä¿¡æ¯ã€‚

3. **é«˜å¯ç”¨é…ç½®**

   - **å¤šMasterèŠ‚ç‚¹**ï¼šé€šè¿‡Nginxè´Ÿè½½å‡è¡¡å®ç°æ•…éšœè½¬ç§»ã€‚
   - **Agentè‡ªåŠ¨æ³¨å†Œ**ï¼šåŸºäºæ ‡ç­¾åŠ¨æ€åˆ†é…ä»»åŠ¡ï¼ˆå¦‚`docker-build`ã€`k8s-deploy`ï¼‰ã€‚

------

#### **3. Jenkinså…±äº«åº“è®¾è®¡ä¸åº”ç”¨**

- ç›®å½•ç»“æ„

  ```
  shared-lib/
  â”œâ”€â”€ src/                # Groovyå·¥å…·ç±»
  â”‚   â””â”€â”€ com/
  â”‚       â””â”€â”€ utils/      # é€šç”¨å·¥å…·ï¼ˆå¦‚æ—¥å¿—ã€é‚®ä»¶é€šçŸ¥ï¼‰
  â”œâ”€â”€ vars/               # å…¨å±€å˜é‡ä¸Pipelineæ­¥éª¤
  â”‚   â””â”€â”€ deploy.groovy   # æ ‡å‡†åŒ–éƒ¨ç½²æµç¨‹
  â””â”€â”€ resources/          # é™æ€èµ„æºï¼ˆå¦‚è„šæœ¬ã€é…ç½®æ¨¡æ¿ï¼‰
  ```

- æ ¸å¿ƒåŠŸèƒ½

  - **æ ‡å‡†åŒ–æ„å»ºæµç¨‹**ï¼šå°è£…Mavenæ„å»ºã€Dockeré•œåƒæ‰“åŒ…ç­‰é€šç”¨æ­¥éª¤ã€‚
  - **è·¨é¡¹ç›®å¤ç”¨**ï¼šé€šè¿‡`@Library('shared-lib@main')`å¼•å…¥å…±äº«åº“ï¼Œå‡å°‘ä»£ç å†—ä½™ã€‚
  - **ç‰ˆæœ¬æ§åˆ¶**ï¼šç»“åˆGitåˆ†æ”¯ç®¡ç†å…±äº«åº“è¿­ä»£ï¼Œæ”¯æŒç°åº¦å‘å¸ƒå›æ»šã€‚

------

#### **4. Jenkins+Ansibleæ‰¹é‡å‘å¸ƒä¸å›é€€**

- æ¶æ„è®¾è®¡

  ```
  graph LR
  A[Jenkins] --> B[Ansible Playbook]
  B --> C{ç¯å¢ƒç±»å‹}
  C -->|ç‰©ç†æœº/è™šæ‹Ÿæœº| D[æ‰§è¡Œæ‰¹é‡éƒ¨ç½²]
  C -->|K8sé›†ç¾¤| E[è°ƒç”¨ArgoCDåŒæ­¥é…ç½®]
  D --> F[å›é€€è‡³å†å²ç‰ˆæœ¬]
  E --> G[ArgoCDå›æ»šGitæäº¤]
  ```

- Ansible Playbookç¤ºä¾‹

  ```
  # deploy.yml
  - hosts: "{{ target }}"
    tasks:
      - name: å¤‡ä»½å½“å‰ç‰ˆæœ¬
        copy:
          src: "{{ app_path }}/current"
          dest: "{{ backup_dir }}/{{ timestamp }}"
      - name: éƒ¨ç½²æ–°ç‰ˆæœ¬
        template: app.conf.j2
        notify: é‡å¯æœåŠ¡
  ```

- å›é€€ç­–ç•¥

  - **ç‰ˆæœ¬å¿«ç…§**ï¼šé€šè¿‡Ansibleå¤‡ä»½å†å²ç‰ˆæœ¬ï¼Œæ”¯æŒä¸€é”®å›æ»šè‡³æŒ‡å®šæ—¶é—´ç‚¹ã€‚
  - **å…ƒæ•°æ®ç®¡ç†**ï¼šè®°å½•æ¯æ¬¡å‘å¸ƒçš„ç‰ˆæœ¬å·ã€å˜æ›´å†…å®¹ï¼Œä¾¿äºè¿½æº¯ã€‚

------

#### **5. Jenkins Runneræ¨¡å¼ä¸å¤šç¯å¢ƒæ„å»º**

- **RunnerèŠ‚ç‚¹åˆ†ç±»**

  | **èŠ‚ç‚¹ç±»å‹**   | **ç¯å¢ƒé…ç½®**           | **é€‚ç”¨åœºæ™¯**   |
  | -------------- | ---------------------- | -------------- |
  | Node.js Runner | Node.js 18 + npm 9     | å‰ç«¯é¡¹ç›®æ„å»º   |
  | Maven Runner   | JDK 11 + Maven 3.8.6   | Javaé¡¹ç›®ç¼–è¯‘   |
  | Docker Runner  | Docker 24.0 + BuildKit | é•œåƒæ„å»ºä¸æ¨é€ |

- **é…ç½®ç¤ºä¾‹**

  ```
  // Jenkinsfile
  pipeline {
    agent {
      label 'nodejs-18'  // æ ¹æ®ç¯å¢ƒé€‰æ‹©Runner
    }
    stages {
      stage('Build') {
        steps {
          sh 'npm install && npm run build'
        }
      }
    }
  }
  ```

- **éš”ç¦»æ€§ä¿éšœ**ï¼šé€šè¿‡Dockerå®¹å™¨å®ç°ç¯å¢ƒéš”ç¦»ï¼Œé¿å…ä¾èµ–å†²çªã€‚

------

#### **6. Jenkins+ArgoCDå®ç°K8S GitOpså‘å¸ƒ**

- **ArgoCDé…ç½®æµç¨‹**

  1. å®šä¹‰Applicationèµ„æº

     ```
     apiVersion: argoproj.io/v1alpha1
     kind: Application
     metadata:
       name: myapp
     spec:
       destination:
         server: https://kubernetes.default.svc
         namespace: default
       source:
         path: manifests/
         repoURL: https://github.com/myorg/myrepo.git
         targetRevision: main
       project: default
       syncPolicy:
         automated: {}  # è‡ªåŠ¨åŒæ­¥
     ```

  2. åŒæ­¥ç­–ç•¥

     - **è‡ªåŠ¨åŒæ­¥**ï¼šGitå˜æ›´è‡ªåŠ¨è§¦å‘K8sèµ„æºæ›´æ–°ã€‚
     - **æ‰‹åŠ¨åŒæ­¥**ï¼šéœ€å®¡æ‰¹åæ‰§è¡Œï¼Œé€‚ç”¨äºç”Ÿäº§ç¯å¢ƒã€‚

- **å›æ»šæœºåˆ¶**

  - **Gitå†å²å›æ»š**ï¼šé€šè¿‡`git checkout <commit>`å›é€€ä»£ç ï¼ŒArgoCDè‡ªåŠ¨åŒæ­¥ã€‚
  - **ç´§æ€¥å›æ»š**ï¼šä½¿ç”¨`argocd app rollback myapp --to-revision <revision>`ã€‚

------

#### **7. ä»£ç è´¨é‡ä¸å®‰å…¨æ‰«æ**

- SonarQubeé›†æˆ

  ```
  // Jenkinsfile
  stage('SonarQube Scan') {
    steps {
      withSonarQubeEnv('SonarQube') {
        sh 'mvn sonar:sonar -Dsonar.projectKey=myproject'
      }
    }
  }
  ```

- å®¹å™¨é•œåƒæ‰«æ

  - **å·¥å…·é€‰æ‹©**ï¼šTrivyã€Clairã€Anchoreã€‚
  - **æµæ°´çº¿é›†æˆ**ï¼šåœ¨æ„å»ºé˜¶æ®µæ‰«æé•œåƒæ¼æ´ï¼Œé˜»æ–­é«˜é£é™©åˆ¶å“ã€‚

------

#### **8. æµæ°´çº¿ä¼˜åŒ–ç­–ç•¥**

- æ„å»ºé€šçŸ¥

  - **å³æ—¶é€šè®¯**ï¼šé›†æˆé’‰é’‰/ä¼ä¸šå¾®ä¿¡æœºå™¨äººï¼Œæ¨é€æ„å»ºç»“æœã€‚
  - **é‚®ä»¶é€šçŸ¥**ï¼šé…ç½®SMTPæœåŠ¡ï¼Œå‘é€è¯¦ç»†æŠ¥å‘Šã€‚

- å‚æ•°åŒ–æ„å»º

  ```
  parameters {
    choice(name: 'ENV', choices: ['dev', 'pre', 'prod'], description: 'éƒ¨ç½²ç¯å¢ƒ')
  }
  ```

- ç¼“å­˜ä¼˜åŒ–

  - **ä¾èµ–ç¼“å­˜**ï¼šåˆ©ç”¨Jenkins Pipelineç¼“å­˜Maven/NPMä»“åº“ã€‚
  - **é•œåƒå±‚ç¼“å­˜**ï¼šDockerfileä¸­åˆç†åˆ†å±‚ï¼Œå‡å°‘é‡å¤æ„å»ºã€‚

------

#### **9. å…¶ä»–å…³é”®æ¨¡å—**

- ç›‘æ§ä¸å‘Šè­¦
  - **Prometheus+Grafana**ï¼šç›‘æ§Jenkinsé˜Ÿåˆ—ã€æ„å»ºæˆåŠŸç‡ã€èŠ‚ç‚¹èµ„æºä½¿ç”¨ç‡ã€‚
  - **æ—¥å¿—åˆ†æ**ï¼šELK Stacké›†ä¸­æ”¶é›†Jenkins Agentæ—¥å¿—ã€‚
- æƒé™ç®¡ç†
  - **RBAC**ï¼šé€šè¿‡Jenkins Role Strategyæ’ä»¶é™åˆ¶ç”¨æˆ·æ“ä½œæƒé™ã€‚
  - **å®¡è®¡æ—¥å¿—**ï¼šè®°å½•æ•æ„Ÿæ“ä½œï¼ˆå¦‚åˆ é™¤ä»»åŠ¡ã€ä¿®æ”¹é…ç½®ï¼‰ã€‚
- ç¾å¤‡æ–¹æ¡ˆ
  - **å¤šæ´»éƒ¨ç½²**ï¼šåœ¨ä¸åŒäº‘æœåŠ¡å•†éƒ¨ç½²Jenkinsé›†ç¾¤ï¼Œé€šè¿‡DNSåˆ‡æ¢å®ç°æ•…éšœè½¬ç§»ã€‚
  - **å®šæœŸå¤‡ä»½**ï¼šå¤‡ä»½Jenkinsé…ç½®ã€å…±äº«åº“ã€Ansible Playbookã€‚

------

### **æœ€ç»ˆå®ç°æ•ˆæœ**

1. **å…¨é“¾è·¯è‡ªåŠ¨åŒ–**ï¼šä»ä»£ç æäº¤åˆ°K8séƒ¨ç½²ï¼Œå…¨ç¨‹é€šè¿‡Jenkinsæµæ°´çº¿é©±åŠ¨ã€‚
2. **ç¯å¢ƒä¸€è‡´æ€§**ï¼šé€šè¿‡RunnerèŠ‚ç‚¹å’ŒAnsibleç¡®ä¿å¼€å‘ã€æµ‹è¯•ã€ç”Ÿäº§ç¯å¢ƒç»Ÿä¸€ã€‚
3. **å®‰å…¨åˆè§„**ï¼šSonarQubeæ‰«æ+é•œåƒæ¼æ´æ£€æµ‹ï¼Œé˜»æ–­ä½è´¨é‡ä»£ç å’Œæ¶æ„é•œåƒã€‚
4. **é«˜å¯ç”¨æ€§**ï¼šK8sé›†ç¾¤+ArgoCDå®ç°åº”ç”¨è‡ªæ„ˆï¼Œæ•…éšœè‡ªåŠ¨æ¢å¤ã€‚

**æŠ€æœ¯æ ˆå…¨æ™¯**ï¼š
![](https://s3api.srebro.cn:443/picgo/202506021106459.png)

## https://pig4cloud.com/ å¾®æœåŠ¡é¡¹ç›®-Pig