---
title: '01 🙃'
description: 'Ansible + jenkins + Library'
---

以下是针对企业级自动化部署平台搭建方案的完善内容，结合最佳实践和行业解决方案，整合了多个技术栈的协同设计：

------

### **企业级自动化部署平台搭建方案**

------

#### **1. Jenkins部署方式对比与选型**

| **部署方式**       | **特点**                              | **适用场景**                 | **优缺点**                               |
| ------------------ | ------------------------------------- | ---------------------------- | ---------------------------------------- |
| **独立服务器部署** | 直接安装Jenkins WAR包，依赖Java环境   | 中小型项目、快速验证         | 简单易用，但扩展性差，单点故障风险高     |
| **Docker容器部署** | 通过Docker镜像快速启动，隔离环境      | 开发测试环境、CI/CD流水线    | 环境一致性高，但镜像体积大，网络配置复杂 |
| **Kubernetes集群** | 以Pod形式运行，支持动态扩缩容、高可用 | 大规模生产环境、弹性计算场景 | 配置复杂，需K8s基础，适合云原生架构      |
| **分布式部署**     | Master节点调度任务，Agent节点执行构建 | 多团队协作、资源隔离         | 扩展性强，但需管理节点网络和权限         |

**选型建议**：

- **生产环境**：优先选择Kubernetes集群部署，结合Jenkins Operator实现自动化扩缩容。
- **混合环境**：采用Master+Agent分布式架构，Agent节点按需部署在物理机/虚拟机/K8s集群中。

------

#### **2. Jenkins核心部署流程**

1. **环境准备**

   - **操作系统**：推荐Ubuntu/CentOS（需提前安装Docker、Java 17+）。
   - **网络配置**：开放8080端口，配置反向代理（Nginx）提升安全性。
   - **存储挂载**：使用PVC持久化Jenkins主目录（`/var/jenkins_home`）。

2. **安装与配置**

   ```
   # Docker部署示例
   docker run -d -p 8080:8080 -p 50000:50000 -v jenkins_home:/var/jenkins_home jenkins/jenkins:lts
   ```

   - **插件安装**：Pipeline、Ansible、Kubernetes、ArgoCD、SonarQube等。
   - **凭证管理**：通过Jenkins凭证插件存储Git密钥、Ansible Vault密码等敏感信息。

3. **高可用配置**

   - **多Master节点**：通过Nginx负载均衡实现故障转移。
   - **Agent自动注册**：基于标签动态分配任务（如`docker-build`、`k8s-deploy`）。

------

#### **3. Jenkins共享库设计与应用**

- 目录结构

  ```
  shared-lib/
  ├── src/                # Groovy工具类
  │   └── com/
  │       └── utils/      # 通用工具（如日志、邮件通知）
  ├── vars/               # 全局变量与Pipeline步骤
  │   └── deploy.groovy   # 标准化部署流程
  └── resources/          # 静态资源（如脚本、配置模板）
  ```

- 核心功能

  - **标准化构建流程**：封装Maven构建、Docker镜像打包等通用步骤。
  - **跨项目复用**：通过`@Library('shared-lib@main')`引入共享库，减少代码冗余。
  - **版本控制**：结合Git分支管理共享库迭代，支持灰度发布回滚。

------

#### **4. Jenkins+Ansible批量发布与回退**

- 架构设计

  ```
  graph LR
  A[Jenkins] --> B[Ansible Playbook]
  B --> C{环境类型}
  C -->|物理机/虚拟机| D[执行批量部署]
  C -->|K8s集群| E[调用ArgoCD同步配置]
  D --> F[回退至历史版本]
  E --> G[ArgoCD回滚Git提交]
  ```

- Ansible Playbook示例

  ```
  # deploy.yml
  - hosts: "{{ target }}"
    tasks:
      - name: 备份当前版本
        copy:
          src: "{{ app_path }}/current"
          dest: "{{ backup_dir }}/{{ timestamp }}"
      - name: 部署新版本
        template: app.conf.j2
        notify: 重启服务
  ```

- 回退策略

  - **版本快照**：通过Ansible备份历史版本，支持一键回滚至指定时间点。
  - **元数据管理**：记录每次发布的版本号、变更内容，便于追溯。

------

#### **5. Jenkins Runner模式与多环境构建**

- **Runner节点分类**

  | **节点类型**   | **环境配置**           | **适用场景**   |
  | -------------- | ---------------------- | -------------- |
  | Node.js Runner | Node.js 18 + npm 9     | 前端项目构建   |
  | Maven Runner   | JDK 11 + Maven 3.8.6   | Java项目编译   |
  | Docker Runner  | Docker 24.0 + BuildKit | 镜像构建与推送 |

- **配置示例**

  ```
  // Jenkinsfile
  pipeline {
    agent {
      label 'nodejs-18'  // 根据环境选择Runner
    }
    stages {
      stage('Build') {
        steps {
          sh 'npm install && npm run build'
        }
      }
    }
  }
  ```

- **隔离性保障**：通过Docker容器实现环境隔离，避免依赖冲突。

------

#### **6. Jenkins+ArgoCD实现K8S GitOps发布**

- **ArgoCD配置流程**

  1. 定义Application资源

     ```
     apiVersion: argoproj.io/v1alpha1
     kind: Application
     metadata:
       name: myapp
     spec:
       destination:
         server: https://kubernetes.default.svc
         namespace: default
       source:
         path: manifests/
         repoURL: https://github.com/myorg/myrepo.git
         targetRevision: main
       project: default
       syncPolicy:
         automated: {}  # 自动同步
     ```

  2. 同步策略

     - **自动同步**：Git变更自动触发K8s资源更新。
     - **手动同步**：需审批后执行，适用于生产环境。

- **回滚机制**

  - **Git历史回滚**：通过`git checkout <commit>`回退代码，ArgoCD自动同步。
  - **紧急回滚**：使用`argocd app rollback myapp --to-revision <revision>`。

------

#### **7. 代码质量与安全扫描**

- SonarQube集成

  ```
  // Jenkinsfile
  stage('SonarQube Scan') {
    steps {
      withSonarQubeEnv('SonarQube') {
        sh 'mvn sonar:sonar -Dsonar.projectKey=myproject'
      }
    }
  }
  ```

- 容器镜像扫描

  - **工具选择**：Trivy、Clair、Anchore。
  - **流水线集成**：在构建阶段扫描镜像漏洞，阻断高风险制品。

------

#### **8. 流水线优化策略**

- 构建通知

  - **即时通讯**：集成钉钉/企业微信机器人，推送构建结果。
  - **邮件通知**：配置SMTP服务，发送详细报告。

- 参数化构建

  ```
  parameters {
    choice(name: 'ENV', choices: ['dev', 'pre', 'prod'], description: '部署环境')
  }
  ```

- 缓存优化

  - **依赖缓存**：利用Jenkins Pipeline缓存Maven/NPM仓库。
  - **镜像层缓存**：Dockerfile中合理分层，减少重复构建。

------

#### **9. 其他关键模块**

- 监控与告警
  - **Prometheus+Grafana**：监控Jenkins队列、构建成功率、节点资源使用率。
  - **日志分析**：ELK Stack集中收集Jenkins Agent日志。
- 权限管理
  - **RBAC**：通过Jenkins Role Strategy插件限制用户操作权限。
  - **审计日志**：记录敏感操作（如删除任务、修改配置）。
- 灾备方案
  - **多活部署**：在不同云服务商部署Jenkins集群，通过DNS切换实现故障转移。
  - **定期备份**：备份Jenkins配置、共享库、Ansible Playbook。

------

### **最终实现效果**

1. **全链路自动化**：从代码提交到K8s部署，全程通过Jenkins流水线驱动。
2. **环境一致性**：通过Runner节点和Ansible确保开发、测试、生产环境统一。
3. **安全合规**：SonarQube扫描+镜像漏洞检测，阻断低质量代码和恶意镜像。
4. **高可用性**：K8s集群+ArgoCD实现应用自愈，故障自动恢复。

**技术栈全景**：
![](https://s3api.srebro.cn:443/picgo/202506021106459.png)

## https://pig4cloud.com/ 微服务项目-Pig